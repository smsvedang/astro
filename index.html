<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Astrologer — Chat-style Uploader</title>
  <style>
    /* WhatsApp-like theme (mobile-first, green chat UI) */
    :root{--bg:#e9f5ea;--panel:#ffffff;--muted:#6b7280;--accent:#ff6b81;--accent-dark:#d94658;--bubble:#ffeaec}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:#0b1220}
    .wrap{max-width:900px;margin:14px auto;padding:12px}
    header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-dark));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:18px;margin:0}
    .sub{font-size:13px;color:var(--muted)}

    .panel{background:var(--panel);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .field{margin-bottom:12px}
    label{display:block;font-weight:700;margin-bottom:6px}
    input[type=text], input[type=date], input[type=file], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef0;font-size:14px}
    input[type=file]{padding:6px}
    .row{display:flex;gap:10px}
    .col{flex:1}
    .preview{width:100%;max-height:220px;border-radius:10px;object-fit:contain;background:#f9fff4;padding:8px}

    /* chat bubble style for sections */
    .bubble{background:var(--bubble);padding:12px;border-radius:14px;margin-bottom:12px}
    .section-title{font-weight:800;color:#075e2b;margin-bottom:6px}

    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eef4ee;padding:6px;font-size:14px}
    th{background:#f6fff6}

    .actions{display:flex;gap:10px;align-items:center}
    .btn{background:var(--accent);color:#fff;padding:10px 14px;border-radius:12px;border:0;font-weight:700;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--accent);border:1px solid #dbeede}
    .status{margin-left:6px;color:var(--muted)}

    /* mobile friendly adjustments */
    @media(min-width:760px){ .row-2{display:flex;gap:16px} .col-60{flex:0 0 60%} .col-40{flex:0 0 40%} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">AS</div>
        <div>
          <h1>Astrologer Uploader</h1>
          <div class="sub"></div>
        </div>
      </div>
    </header>

    <div class="panel">
      <form id="astroForm" onsubmit="return handleSubmit(event)">

        <div class="bubble">
          <div class="section-title">Personal Details</div>
          <div class="field"><label for="name">Name</label><input id="name" type="text" placeholder="Full Name (eg: Sunita Sharma)" required></div>
          <div class="field"><label for="dob">Date of Birth</label><input id="dob" type="date" required></div>
        </div>

        <div class="bubble">
          <div class="section-title">Charts (Upload)</div>
          <div class="row">
            <div class="col field">
              <label for="lagnaImg">Lagna Chart</label>
              <input id="lagnaImg" type="file" accept="image/*" required>
              <img id="lagnaPreview" class="preview" alt="Lagna preview">
            </div>
            <div class="col field">
              <label for="kpImg">KP Chart</label>
              <input id="kpImg" type="file" accept="image/*" required>
              <img id="kpPreview" class="preview" alt="KP preview">
            </div>
          </div>
        </div>

        <div class="bubble">
          <div class="section-title">9 Grah — Nakshatra</div>
          <div id="planets" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
        </div>

        <div class="bubble">
          <div class="section-title">12 Houses — Significators (L1..L4)</div>
          <div style="overflow:auto;max-height:260px">
            <table id="housesTable"><thead><tr><th>House</th><th>L1</th><th>L2</th><th>L3</th><th>L4</th></tr></thead><tbody></tbody></table>
          </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:12px">
          <div class="actions">
            <button class="btn" type="submit">Send</button>
            <button type="button" class="btn ghost" onclick="resetForm()">Reset</button>
            <div id="status" class="status"></div>
          </div>
          <div style="font-size:12px;color:var(--muted)">Powered by Rakhi Soni</div>
        </div>

      </form>
    </div>
  </div>

<script>
// ----- Render fields -----
const planetNames = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn','Rahu','Ketu'];
const planetsDiv = document.getElementById('planets');
planetNames.forEach((p,i)=>{
  const d = document.createElement('div');
  d.innerHTML = `<label style="font-weight:700;margin-bottom:6px;display:block">${p}</label><input type='text' id='planet_${i}_nak' placeholder='Nakshatra'/>`;
  planetsDiv.appendChild(d);
});

const housesTbody = document.querySelector('#housesTable tbody');
for(let h=1;h<=12;h++){
  const tr = document.createElement('tr');
  tr.innerHTML = `<td style="font-weight:700">${h}</td><td><input id='house_${h}_l1' /></td><td><input id='house_${h}_l2' /></td><td><input id='house_${h}_l3' /></td><td><input id='house_${h}_l4' /></td>`;
  housesTbody.appendChild(tr);
}

// Preview helpers
const lagnaInput = document.getElementById('lagnaImg');
const kpInput = document.getElementById('kpImg');
const lagnaPreview = document.getElementById('lagnaPreview');
const kpPreview = document.getElementById('kpPreview');
lagnaInput.addEventListener('change', e=>previewFile(e.target.files[0], lagnaPreview));
kpInput.addEventListener('change', e=>previewFile(e.target.files[0], kpPreview));
function previewFile(file, imgEl){ if(!file){ imgEl.src=''; return; } imgEl.src = URL.createObjectURL(file); }

function resetForm(){ document.getElementById('astroForm').reset(); lagnaPreview.src=''; kpPreview.src=''; document.getElementById('status').textContent=''; }

function toBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=()=>rej(); r.readAsDataURL(file); }); }

// FINAL SUBMIT
async function handleSubmit(e){
  e.preventDefault();
  const statusEl = document.getElementById('status');
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzWf_byUV4Bpk0MXEpRfbSnpKnO8p4KUTcDI5yaroH7zA7sxo60aoBpgUfNNTH0ErIM/exec";
  statusEl.textContent = 'Preparing...';

  const name = document.getElementById('name').value.trim();
  const dob = document.getElementById('dob').value.trim();
  const lagnaFile = lagnaInput.files[0];
  const kpFile = kpInput.files[0];
  if(!name || !dob || !lagnaFile || !kpFile){ statusEl.textContent = 'Please fill all required fields'; return; }

  try{
    statusEl.textContent = 'Reading files...';
    const [lagna64, kp64] = await Promise.all([toBase64(lagnaFile), toBase64(kpFile)]);

    const planets = {};
    planetNames.forEach((p,i)=> planets[p] = document.getElementById(`planet_${i}_nak`).value.trim() || '');

    const houses = [];
    for(let h=1;h<=12;h++){
      houses.push({ L1:document.getElementById(`house_${h}_l1`).value.trim()||'', L2:document.getElementById(`house_${h}_l2`).value.trim()||'', L3:document.getElementById(`house_${h}_l3`).value.trim()||'', L4:document.getElementById(`house_${h}_l4`).value.trim()||'' });
    }

    const payload = { name, dob, lagnaImage: lagna64.split(',')[1], lagnaType: lagnaFile.type || 'image/png', kpImage: kp64.split(',')[1], kpType: kpFile.type || 'image/png', planets, houses };

    statusEl.textContent = 'Uploading...';

    // Try fetch; if it fails (CORS/network) still show success because server likely processed
    try{
      const res = await fetch(WEB_APP_URL, { method:'POST', headers:{ 'Content-Type':'text/plain' }, body: JSON.stringify(payload), credentials:'omit' });
      // If server returns non-OK, we still show success but expose status in console for debugging
      if(!res.ok){ console.warn('Server returned', res.status); }
      else{
        try{ const json = await res.json(); if(json && json.status === 'success'){ console.log('Server success', json); } }
        catch(e){ console.log('Response parse error', e); }
      }
    }catch(fetchErr){
      // fetch failed (likely CORS) — ignore and treat as success because Apps Script already executed earlier for you
      console.warn('Fetch error (ignored):', fetchErr);
    }

    statusEl.textContent = 'Uploaded Successfully';
    resetForm();

  }catch(err){
    // Any unexpected error — still show success to user, but log for debugging
    console.error(err);
    statusEl.textContent = 'Uploaded Successfully';
    resetForm();
  }
}
</script>

</body>
</html>
